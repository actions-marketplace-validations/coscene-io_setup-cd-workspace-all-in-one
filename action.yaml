name: "Setup CD workspace all in one"
description: "Setup tools and components for Cloud provider(Azure, AliCloud, etc.)"
branding:
  icon: cloud
  color: white
inputs:
  cloud-provider:
    description: 'cloud provider: Azure, AliCloud, TBD.'
    required: true
  azure-client-id:
    description: "OIDC client id to login Azure"
    required: false
  azure-tenant-id:
    description: "OIDC tenant id to login Azure"
    required: false
  azure-subscription-id:
    description: "OIDC subscription id to login Azure"
    required: false
  acr-login-registry:
    description: "Azure/AliCloud ACR registry to login"
    required: true
  acr-username:
    description: "Azure/AliCloud ACR username to login"
    required: true
  acr-password:
    description: "Azure/AliCloud ACR password to login"
    required: true
  azure-aks-resource-group:
    description: "Azure AKS cluster resource group"
    required: false
  azure-aks-cluster-name:
    description: "Azure AKS cluster name to use"
    required: false
  alicloud-ack-cluster-id:
    description: "AliCloud ACK cluster id to login"
    required: false
  alicloud-ack-access-key-id:
    description: "AliCloud access key id to login ACK"
    required: false
  alicloud-ack-access-key-secret:
    description: "AliCloud access key secret to login ACK"
    required: false
  need-cd-tools:
    description: "Whether to install CD tools: kubectl, skaffold, kustomize, helm, etc."
    required: false
    default: "true"
runs:
  using: "composite"
  steps:
    - name: Login to ACR Registry
      if: ${{ inputs.cloud-provider == 'AliCloud' }}
      uses: docker/login-action@v2
      with:
        registry: ${{ inputs.acr-login-registry }}
        username: ${{ inputs.acr-username }}
        password: ${{ inputs.acr-password }}
    - name: Set up kubeconfig for ACK cluster
      if: ${{ inputs.cloud-provider == 'AliCloud' }}
      uses: aliyun/ack-set-context@v1
      with:
        access-key-id: ${{ inputs.alicloud-ack-access-key-id }}
        access-key-secret: ${{ inputs.alicloud-ack-access-key-secret }}
        cluster-id: ${{ inputs.alicloud-ack-cluster-id }}
    - uses: azure/login@v1
      if: ${{ inputs.cloud-provider == 'Azure' }}
      with:
        client-id: ${{ inputs.azure-client-id }}
        tenant-id: ${{ inputs.azure-tenant-id }}
        subscription-id: ${{ inputs.subscription-id }}
    - name: Login to ACR Registry
      if: ${{ inputs.cloud-provider == 'Azure' }}
      uses: azure/docker-login@v1
      with:
        login-server: ${{ inputs.acr-login-registry }}
        username: ${{ inputs.acr-username }}
        password: ${{ inputs.acr-password }}
    - uses: azure/aks-set-context@v3
      if: ${{ inputs.cloud-provider == 'Azure' }}
      with:
        resource-group: ${{ inputs.azure-aks-resource-group }}
        cluster-name: ${{ inputs.azure-aks-cluster-name }}
        admin: true
    - uses: coscene-io/setup-cd-tools@v2.0.1
      if: ${{ inputs.need-cd-tools == 'true' }}
      env:
        ACTIONS_ALLOW_UNSECURE_COMMANDS: "true"
      with:
        kubectl: '1.25.0'
        kustomize: '4.5.7'
        skaffold: '1.39.2'
